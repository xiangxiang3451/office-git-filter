name: Test Git Document Diff Output

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-git-diff-output:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice poppler-utils git

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt

    - name: Setup test git repository
      run: |
        # Create clean test environment
        rm -rf test_repo
        mkdir test_repo
        cd test_repo
        
        # Initialize git repo
        git init
        git config user.email "test@ci.com"
        git config user.name "CI Test"
        
        # Copy test documents
        cp ../examples/test.* .
        
        # Configure git attributes for document diff
        cat > .gitattributes << 'EOF'
        *.pdf diff=pdf
        *.docx diff=docx  
        *.xlsx diff=xlsx
        *.pptx diff=pptx
        *.txt diff=text
        EOF
        
        # Configure diff drivers
        git config diff.pdf.textconv "python ../src/git_diff_wrapper.py"
        git config diff.docx.textconv "python ../src/git_diff_wrapper.py"
        git config diff.xlsx.textconv "python ../src/git_diff_wrapper.py"
        git config diff.pptx.textconv "python ../src/git_diff_wrapper.py"
        
        # Initial commit
        git add .
        git commit -m "Initial commit with test documents"

    - name: Create modified Office files
      run: |
        cd test_repo
        echo "=== CREATING MODIFIED OFFICE FILES ==="
        
        # Create modified versions using Python
        python3 << 'EOF'
        import sys
        import os
        sys.path.append('../src')
        
        # For DOCX
        try:
            from docx import Document
            doc = Document('test.docx')
            doc.add_paragraph("MODIFIED: Additional content for CI diff testing")
            doc.save('test_modified.docx')
            print("✓ Modified DOCX created")
        except Exception as e:
            print(f"DOCX modification failed: {e}")
        
        # For XLSX
        try:
            from openpyxl import load_workbook
            wb = load_workbook('test.xlsx')
            ws = wb.active
            ws['Z1'] = "MODIFIED: CI Test Content"
            wb.save('test_modified.xlsx')
            print("✓ Modified XLSX created")
        except Exception as e:
            print(f"XLSX modification failed: {e}")
        
        # For PPTX
        try:
            from pptx import Presentation
            prs = Presentation('test.pptx')
            slide = prs.slides.add_slide(prs.slide_layouts[1])
            slide.shapes.title.text = "MODIFIED: CI Test Slide"
            slide.placeholders[1].text = "Additional content for diff testing"
            prs.save('test_modified.pptx')
            print("✓ Modified PPTX created")
        except Exception as e:
            print(f"PPTX modification failed: {e}")
        EOF
        
        # Replace original files with modified ones
        [ -f "test_modified.docx" ] && mv test_modified.docx test.docx
        [ -f "test_modified.xlsx" ] && mv test_modified.xlsx test.xlsx
        [ -f "test_modified.pptx" ] && mv test_modified.pptx test.pptx
        
        # Also modify text file
        echo "MODIFIED: Additional content for diff testing" >> test.txt

    - name: Test git diff output
      run: |
        cd test_repo
        echo "=== GIT DIFF OUTPUT ==="
        echo ""
        
        echo "--- Full Git Diff ---"
        git diff
        echo ""
        
        echo "--- Individual File Diffs ---"
        for file in test.txt test.pdf test.docx test.xlsx test.pptx; do
          echo "--- $file ---"
          git diff -- "$file"
          echo ""
        done

    - name: Test git diff with textconv
      run: |
        cd test_repo
        echo "=== GIT DIFF WITH TEXTCONV ==="
        echo ""
        
        for file_type in pdf docx xlsx pptx; do
          echo "--- $file_type with textconv ---"
          git diff --textconv -- "test.$file_type"
          echo "----------------------------------------"
          echo ""
        done

    - name: Test git diff cached
      run: |
        cd test_repo
        echo "=== GIT DIFF --CACHED ==="
        echo ""
        
        # Stage changes first
        git add .
        
        echo "--- Staged changes diff ---"
        git diff --cached
        echo ""
        
        echo "--- Individual staged diffs ---"
        for file in test.txt test.pdf test.docx test.xlsx test.pptx; do
          echo "--- $file (staged) ---"
          git diff --cached -- "$file"
          echo ""
        done

    - name: Force text output for binary files
      run: |
        cd test_repo
        echo "=== FORCING TEXT OUTPUT ==="
        echo ""
        
        # Force git to treat Office files as text
        git config diff.pdf.binary false
        git config diff.docx.binary false
        git config diff.xlsx.binary false
        git config diff.pptx.binary false
        
        echo "--- Forced text diff ---"
        git diff