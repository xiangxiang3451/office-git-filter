name: Test Git Document Diff Output

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-git-diff-output:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice poppler-utils git

    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt

    - name: Setup test git repository
      run: |
        # Create clean test environment
        rm -rf test_repo
        mkdir test_repo
        cd test_repo
        
        # Initialize git repo
        git init
        git config user.email "test@ci.com"
        git config user.name "CI Test"
        
        # Copy test documents
        cp ../examples/test.* .
        
        # Configure git attributes for document diff
        cat > .gitattributes << 'EOF'
        *.pdf diff=pdf
        *.docx diff=docx  
        *.xlsx diff=xlsx
        *.pptx diff=pptx
        *.txt diff=text
        EOF
        
        # Configure diff drivers
        git config diff.pdf.textconv "python ../src/git_diff_wrapper.py"
        git config diff.docx.textconv "python ../src/git_diff_wrapper.py"
        git config diff.xlsx.textconv "python ../src/git_diff_wrapper.py"
        git config diff.pptx.textconv "python ../src/git_diff_wrapper.py"
        
        # Initial commit
        git add .
        git commit -m "Initial commit with test documents"

    - name: Test direct wrapper output
      run: |
        echo "=== DIRECT WRAPPER OUTPUT ==="
        echo ""
        
        for file_type in pdf docx xlsx pptx txt; do
          echo "--- $file_type wrapper raw output ---"
          python src/git_diff_wrapper.py "examples/test.$file_type"
          echo ""
          echo "----------------------------------------"
          echo ""
        done

    - name: Create modified versions and test git diff
      run: |
        cd test_repo
        echo "=== GIT DIFF OUTPUT AFTER MODIFICATIONS ==="
        echo ""
        
        # Modify files to create differences
        echo "=== MODIFICATIONS ===" >> test.txt
        echo "Modified content for diff testing" >> test.txt
        
        echo ""
        echo "--- Text File Diff ---"
        git diff test.txt
        echo ""
        
        echo "--- PDF File Diff ---"
        git diff test.pdf
        echo ""
        
        echo "--- DOCX File Diff ---"
        git diff test.docx
        echo ""
        
        echo "--- XLSX File Diff ---"
        git diff test.xlsx
        echo ""
        
        echo "--- PPTX File Diff ---"
        git diff test.pptx
        echo ""

    - name: Test git diff with textconv
      run: |
        cd test_repo
        echo "=== GIT DIFF WITH TEXTCONV ==="
        echo ""
        
        for file_type in pdf docx xlsx pptx; do
          echo "--- $file_type diff with textconv ---"
          git diff --textconv HEAD -- "test.$file_type"
          echo ""
          echo "----------------------------------------"
          echo ""
        done

    - name: Test staged changes diff
      run: |
        cd test_repo
        echo "=== STAGED CHANGES DIFF ==="
        echo ""
        
        # Stage all changes
        git add .
        
        echo "--- Staged diff for all files ---"
        git diff --staged
        echo ""
        
        echo "--- Individual staged diffs ---"
        for file_type in pdf docx xlsx pptx txt; do
          if [ -f "test.$file_type" ]; then
            echo "--- Staged: test.$file_type ---"
            git diff --staged -- "test.$file_type"
            echo ""
          fi
        done

    - name: Final diff summary
      run: |
        cd test_repo
        echo "=== FINAL DIFF SUMMARY ==="
        echo ""
        
        echo "--- All changes summary ---"
        git diff --stat
        echo ""
        
        echo "--- Git status ---"
        git status
        echo ""
        
        echo "=== GIT DIFF TESTING COMPLETE ==="